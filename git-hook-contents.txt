#!/bin/bash

# Path to the test reports directory
REPORTS_DIR="tests/reports"
STRATEGY_LOGS_DIR="tests/strategy_logs"

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Function to display test results and strategy analysis
show_results() {
    echo "Checking test results before push..."
    echo -e "${BOLD}----------------------------------------${NC}"

    # Run tests and generate latest report
    echo -e "${CYAN}Running test suite...${NC}"
    if ! python tests/ai_test_runner.py; then
        echo -e "${RED}Test execution failed${NC}"
        return 1
    fi

    # Display test summary if available
    if [ -f "${REPORTS_DIR}/test-report.md" ]; then
        echo -e "\n${BOLD}Test Summary:${NC}"
        echo -e "${BOLD}----------------------------------------${NC}"
        
        # Extract and display quick summary section
        echo -e "${CYAN}Test Overview:${NC}"
        sed -n '/^## Quick Summary/,/^##/p' "${REPORTS_DIR}/test-report.md" | \
            sed '$d' | sed 's/^## Quick Summary//'

        # Display failed tests if any
        if grep -q "## Failed Tests" "${REPORTS_DIR}/test-report.md"; then
            echo -e "\n${RED}Failed Tests:${NC}"
            sed -n '/^## Failed Tests/,/^##/p' "${REPORTS_DIR}/test-report.md" | \
                sed '$d' | sed 's/^## Failed Tests//'
        fi
        
        echo -e "${BOLD}----------------------------------------${NC}"
    else
        echo -e "${RED}No test summary found. Please run tests first.${NC}"
        return 1
    fi

    # Display strategy analysis if available
    if [ -f "${STRATEGY_LOGS_DIR}/latest_summary.md" ]; then
        echo -e "\n${BOLD}Test Strategy Analysis:${NC}"
        echo -e "${BOLD}----------------------------------------${NC}"
        
        # Extract and display critical issues
        if grep -q "## Critical Issues" "${STRATEGY_LOGS_DIR}/latest_summary.md"; then
            echo -e "${RED}Critical Issues:${NC}"
            sed -n '/^## Critical Issues/,/^##/p' "${STRATEGY_LOGS_DIR}/latest_summary.md" | \
                sed '$d' | sed 's/^## Critical Issues//'
        fi
        
        # Extract and display recommendations
        if grep -q "## Recommendations" "${STRATEGY_LOGS_DIR}/latest_summary.md"; then
            echo -e "\n${YELLOW}Recommendations:${NC}"
            sed -n '/^## Recommendations/,/^##/p' "${STRATEGY_LOGS_DIR}/latest_summary.md" | \
                sed '$d' | sed 's/^## Recommendations//'
        fi
        
        echo -e "${BOLD}----------------------------------------${NC}"
    else
        echo -e "${YELLOW}No strategy analysis available.${NC}"
    fi

    return 0
}

# Show test results and strategy analysis
show_results

# Ask for confirmation
echo -e "\n${BOLD}Have you reviewed the test results and strategy analysis? (y/n)${NC}"
read -r REPLY

if [[ "$REPLY" =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}Proceeding with push...${NC}"
    exit 0
else
    echo -e "${RED}Push aborted. Please review test results and fix any issues before pushing.${NC}"
    exit 1
fi
